# TODO : –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä—è—Ç—å, –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏ –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã. –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–≤–µ—Ä—è—Ç—å json –∏ —Ñ–∞–π–ª—ã –Ω–∞ –¥–∏—Å–∫–µ, –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è, —Ç–æ —É–∫–∞–∑—ã–≤–∞—Ç—å –∏—Ö –∫–∞–∫ –Ω–µ —Å–∫–∞—á–∞–Ω–Ω—ã–µ
# –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–∏—Ç –∏—Ö –≤ —Ä—É—á–Ω—É—é –∏–∑ –ø–∞–ø–æ–∫, –≤—Å–µ —Ä–∞–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ –±—É–¥—Ç–æ –æ–Ω–∏ –µ—Å—Ç—å, –Ω—É–∂–Ω–æ –≤–∏–¥–∏–º–æ —Å–¥–µ–ª–∞—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é, –∞ —Ç–∞–∫–∂–µ —Å–¥–µ–ª–∞—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏—è, –µ—Å–ª–∏ 
# –≤—Å–µ –∂–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –æ—à–∏–±–∫–∞ –∫–æ–≥–¥–∞ –ø—ã—Ç–∞–µ—â—å—Å—è –æ—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª –∫–æ—Ç–æ—Ä—ã–π —É–¥–∞–ª–µ–Ω –≤ —Ä—É—á–Ω—É—é, —Ç–æ –º–± —Å–¥–µ–ª–∞—Ç—å –µ–≥–æ —Å–µ—Ä—ã–º, –∫–∞–∫ –Ω–µ —Å–∫–∞—á–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã, —è —Ö–∑, –Ω—É–∂–Ω–æ –ø–æ–¥—É–º–∞—Ç—å
# TODO : —Å–æ–∑–¥–∞—Ç—å requirements.txt
# –µ—â–µ –Ω—É–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ—á–µ–º—É —è —Å–æ–∑–¥–∞–≤–∞–ª –ª–æ–∫–∞–ª—å–Ω–æ —Ñ–∞–π–ª "–î–æ–∫—É–º–µ–Ω—Ç—ã", –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è, –º–± –Ω—É–∂–Ω–æ –±—ã–ª–æ –¥–ª—è —á–µ–≥–æ —Ç–æ, –µ—Å–ª–∏ –Ω–µ—Ç, –Ω—É–∂–Ω–æ —É–±—Ä–∞—Ç—å, –∑–∞—á–µ–º –Ω–∞–º –º—É—Å–æ—Ä
# –¥—É–º–∞—é –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –º–æ–∂–Ω–æ –∏ –æ—Ç–¥–∞–≤–∞—Ç—å –µ–≥–æ –≤ —Ä–∞–±–æ—Ç—É
# TODO : –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫—Ä–æ–ø–∫—É —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–¥–µ–ª–∞—Ç—å —Ç–∞–∫—É—é –∂–µ –∞–Ω–∏–º–∞—Ü–∏—é –∫–∞–∫ –∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (3 —Ç–æ—á–∫–∏) –∏–ª–∏ –∫–∞–∫ –Ω–∏–±—É–¥—å –ø–æ –¥—Ä—É–≥–æ–º—É –ø—Ä–∏–¥—É–º–∞–µ–º.
import os
import sys
import json
import fitz
from webdav3.client import Client
import shutil
from PIL import Image
from datetime import datetime
from dotenv import load_dotenv
import webbrowser
import tempfile
import io
# –≤–µ—Å—å –Ω–∞—à –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, —Å–ª–æ–∂–Ω–æ –Ω–æ –º–æ–∂–Ω–æ
from PyQt6.QtCore import Qt, QThread, pyqtSignal, QSize, QTimer
from PyQt6.QtGui import QPixmap, QIcon, QFontMetrics, QColor
from PyQt6.QtWidgets import (QApplication, QMainWindow, QVBoxLayout, QWidget, QListWidget, 
                            QPushButton, QFileDialog, QMessageBox, QLabel, QHBoxLayout,
                            QScrollArea, QListWidgetItem, QSizePolicy, QComboBox, 
                            QLineEdit, QDialog, QFormLayout, QDialogButtonBox, QTabWidget,
                            QTableWidget, QTableWidgetItem, QHeaderView)


load_dotenv()

# –ö–ª–∞—Å—Å –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–∞
class DownloadThread(QThread):
    finished = pyqtSignal(bool, str, str, str)  # –¥–æ–±–∞–≤–∏–ª local_path
    
    def __init__(self, webdav_client, remote_path, local_path):
        super().__init__()
        self.webdav_client = webdav_client
        self.remote_path = remote_path
        self.local_path = local_path
    
    def run(self):
        try:
            self.webdav_client.download(self.remote_path, self.local_path)
            self.finished.emit(True, "–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω", self.remote_path, self.local_path)
        except Exception as e:
            self.finished.emit(False, f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª: {str(e)}", self.remote_path, self.local_path)


# –ö–ª–∞—Å—Å –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫
class UploadThread(QThread):
    finished = pyqtSignal(bool, str)
    
    def __init__(self, webdav_client, remote_path, local_path):
        super().__init__()
        self.webdav_client = webdav_client
        self.remote_path = remote_path
        self.local_path = local_path
    
    def run(self):
        try:
            self.webdav_client.upload(remote_path=self.remote_path, local_path=self.local_path)
            self.finished.emit(True, f"–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫: {self.remote_path}")
        except Exception as e:
            self.finished.emit(False, f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫: {str(e)}")

# –ö–ª–∞—Å—Å –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
class SyncThread(QThread):
    finished = pyqtSignal(bool, str)
    progress = pyqtSignal(str)
    
    def __init__(self, webdav_client, base_dir, data_file):
        super().__init__()
        self.webdav_client = webdav_client
        self.base_dir = base_dir
        self.data_file = data_file
        self._is_running = True

    def run(self):
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –ø–µ—Ä–µ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π
            self.progress.emit("–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤...")
            self.validate_local_files()
            
            self.progress.emit("–©–∞ –≤—Å–µ –±—É–¥–µ—Ç...")
            remote_docs = self.check_remote_updates()
            
            if not remote_docs:
                self.finished.emit(True, "–ù–æ–≤—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
                return
                
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            with open(self.data_file, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            updated = False
            existing_docs = {
                (d['filename'].lower(), 
                 d['type'], 
                 d.get('doc_number', '').lower(),
                 d.get('sender', '').lower(),
                 d.get('executor', '').lower())
                for d in data['documents']
            }
            
            for remote in remote_docs:
                if not self._is_running:
                    break
                    
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
                doc_key = (
                    remote['filename'].lower(),
                    remote['type'],
                    remote.get('doc_number', '').lower(),
                    remote.get('sender', '').lower(),
                    remote.get('executor', '').lower()
                )
                
                if doc_key not in existing_docs:
                    doc_data = {
                        'filename': remote['filename'],
                        'type': remote['type'],
                        'path': f"yadisk:{remote['path']}",
                        'remote_path': remote['path'],
                        'date': datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                        'size': self.webdav_client.info(remote['path']).get('size', 0)
                    }
                    
                    if 'sender' in remote:
                        doc_data['sender'] = remote['sender']
                    if 'doc_number' in remote:
                        doc_data['doc_number'] = remote['doc_number']
                    
                    data['documents'].append(doc_data)
                    updated = True
            
            if updated:
                with open(self.data_file, 'w', encoding='utf-8') as f:
                    json.dump(data, f, ensure_ascii=False, indent=4)
                self.finished.emit(True, "–î–æ–∫—É–º–µ–Ω—Ç—ã —É—Å–ø–µ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã")
            else:
                self.finished.emit(True, "–ù–æ–≤—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
                
        except Exception as e:
            self.finished.emit(False, f"–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: {str(e)}")

    def check_remote_updates(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–µ"""
        try:
            remote_docs = []
            base_dir = '/–î–æ–∫—É–º–µ–Ω—Ç—ã/'
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞–ø–∫—É –í—Ö–æ–¥—è—â–∏–µ
            incoming_dir = f'{base_dir}–í—Ö–æ–¥—è—â–∏–µ/'
            if self.webdav_client.check(incoming_dir):
                for item in self.webdav_client.list(incoming_dir):
                    if not item.endswith('/'):
                        remote_docs.append({
                            'path': incoming_dir + item,
                            'type': 'incoming',
                            'filename': item
                        })
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∞–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–π
                for sender in self.webdav_client.list(incoming_dir):
                    if sender.endswith('/'):
                        sender_dir = incoming_dir + sender
                        for item in self.webdav_client.list(sender_dir):
                            if not item.endswith('/'):
                                remote_docs.append({
                                    'path': sender_dir + item,
                                    'type': 'incoming',
                                    'sender': sender[:-1],
                                    'filename': item
                                })
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞–ø–∫—É –ò—Å—Ö–æ–¥—è—â–∏–µ
            outgoing_dir = f'{base_dir}–ò—Å—Ö–æ–¥—è—â–∏–µ/'
            if self.webdav_client.check(outgoing_dir):
                for item in self.webdav_client.list(outgoing_dir):
                    if not item.endswith('/'):
                        remote_docs.append({
                            'path': outgoing_dir + item,
                            'type': 'outgoing',
                            'filename': item
                        })
            
            return remote_docs
            
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: {e}")
            return []

    def validate_local_files(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤"""
        try:
            with open(self.data_file, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            changed = False
            for doc in data['documents']:
                # –ï—Å–ª–∏ —Ñ–∞–π–ª –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –ª–æ–∫–∞–ª—å–Ω—ã–π, –Ω–æ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                if not doc['path'].startswith('yadisk:') and not os.path.exists(doc['path']):
                    # –ï—Å–ª–∏ –µ—Å—Ç—å remote_path, –º–µ–Ω—è–µ–º –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–π
                    if 'remote_path' in doc:
                        doc['path'] = f"yadisk:{doc['remote_path']}"
                        changed = True
                    # –ï—Å–ª–∏ –Ω–µ—Ç remote_path, —É–¥–∞–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç (—Ñ–∞–π–ª –±—ã–ª —É–¥–∞–ª–µ–Ω –≤—Ä—É—á–Ω—É—é)
                    else:
                        data['documents'].remove(doc)
                        changed = True
            
            if changed:
                with open(self.data_file, 'w', encoding='utf-8') as f:
                    json.dump(data, f, ensure_ascii=False, indent=4)
                    
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤: {e}")

    def stop(self):
        self._is_running = False

class PreviewThread(QThread):
    preview_generated = pyqtSignal(str, object)
    
    def __init__(self, file_path, preview_manager):
        super().__init__()
        self.file_path = file_path
        self.preview_manager = preview_manager
    
    def run(self):
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–≤—å—é –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ"""
        try:
            if self.file_path.startswith('yadisk:'):
                self.preview_generated.emit(self.file_path, "remote")
                return
                
            if not os.path.exists(self.file_path):
                self.preview_generated.emit(self.file_path, "missing")
                return
            
            # –ü–æ–ª—É—á–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
            ext = os.path.splitext(self.file_path)[1].lower()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
            supported_formats = ['.pdf', '.png', '.jpg', '.jpeg', '.bmp', '.tiff', '.tif']
            if ext not in supported_formats:
                self.preview_generated.emit(self.file_path, "unsupported")
                return
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–µ–≤—å—é
            preview_path = self.preview_manager.create_preview(self.file_path)
            if preview_path and os.path.exists(preview_path):
                pixmap = QPixmap(preview_path)
                self.preview_generated.emit(self.file_path, pixmap)
            else:
                self.preview_generated.emit(self.file_path, "error")
                
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–µ–≤—å—é –≤ –ø–æ—Ç–æ–∫–µ: {e}")
            self.preview_generated.emit(self.file_path, "error")


class PreviewManager:
    def __init__(self):
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –∫—ç—à–∞ –ø—Ä–µ–≤—å—é
        self.cache_dir = os.path.join(tempfile.gettempdir(), 'document_archive_previews')
        os.makedirs(self.cache_dir, exist_ok=True)
    
    def create_preview(self, file_path, output_path=None):
        """–°–æ–∑–¥–∞–µ—Ç –ø—Ä–µ–≤—å—é –¥–ª—è —Ñ–∞–π–ª–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤"""
        try:
            # –î–ª—è —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –ø—Ä–µ–≤—å—é –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ
            if file_path.startswith('yadisk:'):
                return None
                
            # –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None
            if not os.path.exists(file_path):
                return None
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
            ext = os.path.splitext(file_path)[1].lower()
            
            # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –ø—Ä–µ–≤—å—é, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω –≤—ã—Ö–æ–¥–Ω–æ–π –ø—É—Ç—å
            if output_path is None:
                output_path = os.path.join(self.cache_dir, f"preview_{os.path.basename(file_path)}.png")
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–µ–≤—å—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–æ—Ä–º–∞—Ç–∞
            if ext == '.pdf':
                # –î–ª—è PDF –∏—Å–ø–æ–ª—å–∑—É–µ–º PyMuPDF
                doc = fitz.open(file_path)
                page = doc.load_page(0)
                pix = page.get_pixmap(matrix=fitz.Matrix(4, 4))
                pix.save(output_path)
                doc.close()
                return output_path
                
            elif ext in ['.png', '.jpg', '.jpeg', '.bmp', '.tiff', '.tif']:
                # –î–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ–º PIL
                img = Image.open(file_path)
                img.thumbnail((800, 600))  # –ò–∑–º–µ–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä
                img.save(output_path, 'PNG')
                return output_path
                
            else:
                # –î–ª—è –¥—Ä—É–≥–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –ø—Ä–µ–≤—å—é –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ
                return None

        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–µ–≤—å—é: {e}")
            return None
    
    def get_preview_pixmap(self, file_path):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç QPixmap —Å –ø—Ä–µ–≤—å—é –¥–æ–∫—É–º–µ–Ω—Ç–∞"""
        preview_path = self.create_preview(file_path)
        if preview_path and os.path.exists(preview_path):
            pixmap = QPixmap(preview_path)
            if not pixmap.isNull():
                return pixmap
        return None
    
    def cleanup(self):
        """–û—á–∏—â–∞–µ—Ç –∫—ç—à –ø—Ä–µ–≤—å—é"""
        try:
            shutil.rmtree(self.cache_dir)
            os.makedirs(self.cache_dir, exist_ok=True)
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞ –ø—Ä–µ–≤—å—é: {e}")

class OpenFileThread(QThread):
    finished = pyqtSignal()
    
    def __init__(self, file_path):
        super().__init__()
        self.file_path = file_path
    
    def run(self):
        try:
            if sys.platform == 'win32':
                os.startfile(self.file_path)
            elif sys.platform == 'darwin':
                os.system(f'open "{self.file_path}"')
            else:
                os.system(f'xdg-open "{self.file_path}"')
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ñ–∞–π–ª–∞: {e}")
        finally:
            self.finished.emit()

class SettingsDialog(QDialog):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle("–ù–∞—Å—Ç—Ä–æ–π–∫–∏")
        self.setFixedSize(600, 400)
        
        self.parent = parent
        self.init_ui()
        self.load_data()
    
    def init_ui(self):
        layout = QVBoxLayout()
        self.setLayout(layout)
        
        tabs = QTabWidget()
        layout.addWidget(tabs)
        
        self.senders_tab = QWidget()
        self.senders_layout = QVBoxLayout(self.senders_tab)
        
        self.senders_table = QTableWidget()
        self.senders_table.setColumnCount(3)
        self.senders_table.setHorizontalHeaderLabels(["ID", "–ò–º—è", "–û–ø–∏—Å–∞–Ω–∏–µ"])
        self.senders_table.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        self.senders_table.setSelectionBehavior(QTableWidget.SelectionBehavior.SelectRows)
        
        add_sender_btn = QPushButton("–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è")
        add_sender_btn.clicked.connect(self.add_sender)
        remove_sender_btn = QPushButton("–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ")
        remove_sender_btn.clicked.connect(self.remove_sender)
        
        btn_layout = QHBoxLayout()
        btn_layout.addWidget(add_sender_btn)
        btn_layout.addWidget(remove_sender_btn)
        
        self.senders_layout.addWidget(self.senders_table)
        self.senders_layout.addLayout(btn_layout)
        
        self.executors_tab = QWidget()
        self.executors_layout = QVBoxLayout(self.executors_tab)
        
        self.executors_table = QTableWidget()
        self.executors_table.setColumnCount(3)
        self.executors_table.setHorizontalHeaderLabels(["ID", "–ò–º—è", "–û–ø–∏—Å–∞–Ω–∏–µ"])
        self.executors_table.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        self.executors_table.setSelectionBehavior(QTableWidget.SelectionBehavior.SelectRows)
        
        add_executor_btn = QPushButton("–î–æ–±–∞–≤–∏—Ç—å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è")
        add_executor_btn.clicked.connect(self.add_executor)
        remove_executor_btn = QPushButton("–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ")
        remove_executor_btn.clicked.connect(self.remove_executor)
        
        btn_layout = QHBoxLayout()
        btn_layout.addWidget(add_executor_btn)
        btn_layout.addWidget(remove_executor_btn)
        
        self.executors_layout.addWidget(self.executors_table)
        self.executors_layout.addLayout(btn_layout)
        
        tabs.addTab(self.senders_tab, "–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–∏")
        tabs.addTab(self.executors_tab, "–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏")
        
        button_box = QDialogButtonBox(QDialogButtonBox.StandardButton.Ok | QDialogButtonBox.StandardButton.Cancel)
        button_box.accepted.connect(self.accept)
        button_box.rejected.connect(self.reject)
        layout.addWidget(button_box)
    
    def load_data(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–π –∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π"""
        data = self.parent.load_data()
        
        self.senders_table.setRowCount(len(data["senders"]))
        for row, sender in enumerate(data["senders"]):
            self.senders_table.setItem(row, 0, QTableWidgetItem(str(sender["id"])))
            self.senders_table.setItem(row, 1, QTableWidgetItem(sender["name"]))
            self.senders_table.setItem(row, 2, QTableWidgetItem(sender.get("description", "")))
        
        self.executors_table.setRowCount(len(data["executors"]))
        for row, executor in enumerate(data["executors"]):
            self.executors_table.setItem(row, 0, QTableWidgetItem(str(executor["id"])))
            self.executors_table.setItem(row, 1, QTableWidgetItem(executor["name"]))
            self.executors_table.setItem(row, 2, QTableWidgetItem(executor.get("description", "")))
    
    def add_sender(self):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è"""
        dialog = QDialog(self)
        dialog.setWindowTitle("–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è")
        dialog.setFixedSize(300, 150)
        
        layout = QFormLayout()
        dialog.setLayout(layout)
        
        name_edit = QLineEdit()
        description_edit = QLineEdit()
        
        layout.addRow("–ò–º—è:", name_edit)
        layout.addRow("–û–ø–∏—Å–∞–Ω–∏–µ:", description_edit)
        
        button_box = QDialogButtonBox(QDialogButtonBox.StandardButton.Ok | QDialogButtonBox.StandardButton.Cancel)
        button_box.accepted.connect(dialog.accept)
        button_box.rejected.connect(dialog.reject)
        
        layout.addRow(button_box)
        
        if dialog.exec() == QDialog.DialogCode.Accepted:
            name = name_edit.text().strip()
            if not name:
                QMessageBox.warning(self, "–û—à–∏–±–∫–∞", "–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º")
                return
            
            data = self.parent.load_data()
            if any(s["name"].lower() == name.lower() for s in data["senders"]):
                QMessageBox.warning(self, "–û—à–∏–±–∫–∞", "–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
                return
            
            new_id = max(s["id"] for s in data["senders"]) + 1 if data["senders"] else 1
            new_sender = {
                "id": new_id,
                "name": name,
                "description": description_edit.text(),
                "created_at": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            }
            
            data["senders"].append(new_sender)
            self.parent.save_data(data)
            self.load_data()
    
    def remove_sender(self):
        """–£–¥–∞–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è"""
        selected = self.senders_table.currentRow()
        if selected == -1:
            QMessageBox.warning(self, "–û—à–∏–±–∫–∞", "–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è")
            return
        
        sender_id = int(self.senders_table.item(selected, 0).text())
        sender_name = self.senders_table.item(selected, 1).text()
        
        reply = QMessageBox.question(
            self, 
            '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ', 
            f'–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è "{sender_name}"?', 
            QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No
        )
        
        if reply == QMessageBox.StandardButton.Yes:
            data = self.parent.load_data()
            data["senders"] = [s for s in data["senders"] if s["id"] != sender_id]
            self.parent.save_data(data)
            self.load_data()
    
    def add_executor(self):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è"""
        dialog = QDialog(self)
        dialog.setWindowTitle("–î–æ–±–∞–≤–∏—Ç—å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è")
        dialog.setFixedSize(300, 150)
        
        layout = QFormLayout()
        dialog.setLayout(layout)
        
        name_edit = QLineEdit()
        description_edit = QLineEdit()
        
        layout.addRow("–ò–º—è:", name_edit)
        layout.addRow("–û–ø–∏—Å–∞–Ω–∏–µ:", description_edit)
        
        button_box = QDialogButtonBox(QDialogButtonBox.StandardButton.Ok | QDialogButtonBox.StandardButton.Cancel)
        button_box.accepted.connect(dialog.accept)
        button_box.rejected.connect(dialog.reject)
        
        layout.addRow(button_box)
        
        if dialog.exec() == QDialog.DialogCode.Accepted:
            name = name_edit.text().strip()
            if not name:
                QMessageBox.warning(self, "–û—à–∏–±–∫–∞", "–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º")
                return
            
            data = self.parent.load_data()
            if any(e["name"].lower() == name.lower() for e in data["executors"]):
                QMessageBox.warning(self, "–û—à–∏–±–∫–∞", "–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
                return
            
            new_id = max(e["id"] for e in data["executors"]) + 1 if data["executors"] else 1
            new_executor = {
                "id": new_id,
                "name": name,
                'description': description_edit.text(),
                'created_at': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            }
            
            data['executors'].append(new_executor)
            self.parent.save_data(data)
            self.load_data()
    
    def remove_executor(self):
        """–£–¥–∞–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è"""
        selected = self.executors_table.currentRow()
        if selected == -1:
            QMessageBox.warning(self, '–û—à–∏–±–∫–∞', '–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è')
            return
        
        executor_id = int(self.executors_table.item(selected, 0).text())
        executor_name = self.executors_table.item(selected, 1).text()
        
        reply = QMessageBox.question(
            self, 
            '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ', 
            f'–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è "{executor_name}"?', 
            QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No
        )
        
        if reply == QMessageBox.StandardButton.Yes:
            data = self.parent.load_data()
            data['executors'] = [e for e in data['executors'] if e['id'] != executor_id]
            self.parent.save_data(data)
            self.load_data()


class DocumentUploadDialog(QDialog):
    def __init__(self, doc_type, parent=None):
        super().__init__(parent)
        self.setWindowTitle(f"–î–µ—Ç–∞–ª–∏ {'–≤—Ö–æ–¥—è—â–µ–≥–æ' if doc_type == 'incoming' else '–∏—Å—Ö–æ–¥—è—â–µ–≥–æ'} –ø–∏—Å—å–º–∞")
        self.setFixedSize(300, 200)
        
        layout = QFormLayout()
        self.setLayout(layout)
        
        self.doc_number = QLineEdit()
        self.doc_date = QLineEdit()
        self.doc_date.setPlaceholderText("–î–î.–ú–ú.–ì–ì–ì–ì")
        
        layout.addRow("–ù–æ–º–µ—Ä –ø–∏—Å—å–º–∞:", self.doc_number)
        layout.addRow("–î–∞—Ç–∞ –ø–∏—Å—å–º–∞:", self.doc_date)
        
        button_box = QDialogButtonBox(QDialogButtonBox.StandardButton.Ok | QDialogButtonBox.StandardButton.Cancel)
        button_box.accepted.connect(self.accept)
        button_box.rejected.connect(self.reject)
        
        layout.addRow(button_box)
    
    def get_data(self):
        return {
            "doc_number": self.doc_number.text().strip(),
            "doc_date": self.doc_date.text().strip()
        }

class DocumentManager(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("–ê—Ä—Ö–∏–≤ Local/Web")
        self.setGeometry(100, 100, 1000, 600)
        
        self.base_dir = os.path.join(os.path.dirname(__file__), "–î–æ–∫—É–º–µ–Ω—Ç—ã –∞—Ä—Ö–∏–≤–∞")
        self.incoming_dir = os.path.join(self.base_dir, "–í—Ö–æ–¥—è—â–∏–µ")
        self.outgoing_dir = os.path.join(self.base_dir, "–ò—Å—Ö–æ–¥—è—â–∏–µ")
        
        # –°–æ–∑–¥–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–∞–ø–∫–∏
        os.makedirs(self.base_dir, exist_ok=True)
        os.makedirs(self.incoming_dir, exist_ok=True)
        os.makedirs(self.outgoing_dir, exist_ok=True)
        
        self.data_file = os.path.join(self.base_dir, "data.json")
        self.init_data()

        self.preview_manager = PreviewManager()

        self.preview_thread = None
        self.download_thread = None
        self.upload_thread = None
        self.sync_thread = None
        
        # –°–ª–æ–≤–∞—Ä—å –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏
        self.download_status = {}
        
        yandex_login = 'mtsuTR@yandex.ru'
        yandex_password = 'jmwxecmafywqbrzi'

        self.webdav_client = Client({
            'webdav_hostname': 'https://webdav.yandex.ru',
            'webdav_login': yandex_login,  
            'webdav_password': yandex_password      
        })
        
        self.init_ui()
        self.migrate_data()
        self.validate_local_files()  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
        self.load_documents()
        self.showMaximized()

    def validate_local_files(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ"""
        try:
            data = self.load_data()
            changed = False
            
            for doc in data['documents']:
                # –ï—Å–ª–∏ —Ñ–∞–π–ª –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –ª–æ–∫–∞–ª—å–Ω—ã–π, –Ω–æ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                if not doc['path'].startswith('yadisk:') and not os.path.exists(doc['path']):
                    # –ï—Å–ª–∏ –µ—Å—Ç—å remote_path, –º–µ–Ω—è–µ–º –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–π
                    if 'remote_path' in doc:
                        doc['path'] = f"yadisk:{doc['remote_path']}"
                        changed = True
                    # –ï—Å–ª–∏ –Ω–µ—Ç remote_path, —É–¥–∞–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç (—Ñ–∞–π–ª –±—ã–ª —É–¥–∞–ª–µ–Ω –≤—Ä—É—á–Ω—É—é)
                    else:
                        data['documents'].remove(doc)
                        changed = True
            
            if changed:
                self.save_data(data)
                print("–û–±–Ω–æ–≤–ª–µ–Ω—ã –∑–∞–ø–∏—Å–∏ –æ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö")
                    
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤: {e}")

    def init_data(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ"""
        if not os.path.exists(self.data_file):
            data = {
                "documents": [],
                "senders": [],
                "executors": [],
                "current_user": None
            }
            with open(self.data_file, 'w', encoding='utf-8') as f:
                json.dump(data, f, ensure_ascii=False, indent=4)
    
    def load_data(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ JSON"""
        with open(self.data_file, 'r', encoding='utf-8') as f:
            return json.load(f)
    
    def save_data(self, data):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ JSON"""
        with open(self.data_file, 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=4)
    
    def update_preview(self, file_path):
        """–ó–∞–ø—É—Å–∫–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø—Ä–µ–≤—å—é –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ"""
        try:
            if file_path.startswith('yadisk:'):
                self.clear_preview()
                return
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–æ—Ç–æ–∫, –µ—Å–ª–∏ –æ–Ω –∑–∞–ø—É—â–µ–Ω
            if self.preview_thread and self.preview_thread.isRunning():
                self.preview_thread.quit()
                self.preview_thread.wait()
            
            # –°–æ–∑–¥–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫
            self.preview_thread = PreviewThread(file_path, self.preview_manager)
            self.preview_thread.preview_generated.connect(self.on_preview_generated)
            self.preview_thread.start()
            
            # –í—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ —Å –Ω–æ—Ä–º–∞–ª—å–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º —à—Ä–∏—Ñ—Ç–∞
            self.preview_widget.clear()
            self.preview_widget.setText("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–≤—å—é...")
            self.preview_widget.setStyleSheet("""
                QLabel {
                    font-size: 14px;
                    background-color: rgba(255, 255, 255, 0.1);
                    border: 1px solid #4a6fa5;
                    border-radius: 5px;
                }
            """)
                
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–æ—Ç–æ–∫–∞ –ø—Ä–µ–≤—å—é: {e}")
            self.clear_preview()

    def on_preview_generated(self, file_path, result):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–µ–≤—å—é"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–µ–≤—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–∫—É—â–µ–º—É –¥–æ–∫—É–º–µ–Ω—Ç—É
        current_item = self.documents_list.currentItem()
        if current_item and current_item.data(Qt.ItemDataRole.UserRole)["path"] == file_path:
            if isinstance(result, QPixmap) and not result.isNull():
                # –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –ø—Ä–µ–≤—å—é –ø–æ–¥ —Ä–∞–∑–º–µ—Ä –≤–∏–¥–∂–µ—Ç–∞
                scaled_pixmap = result.scaled(
                    self.preview_widget.width() - 20, 
                    self.preview_widget.height() - 20,
                    Qt.AspectRatioMode.KeepAspectRatio,
                    Qt.TransformationMode.SmoothTransformation
                )
                self.preview_widget.setPixmap(scaled_pixmap)
                # –£–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Å—Ç–∏–ª—å, —Ç–∞–∫ –∫–∞–∫ —Ç–µ–ø–µ—Ä—å —É –Ω–∞—Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                self.preview_widget.setStyleSheet("""
                    QLabel {
                        background-color: rgba(255, 255, 255, 0.1);
                        border: 1px solid #4a6fa5;
                        border-radius: 5px;
                    }
                """)
            else:
                # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–º–∞–π–ª–∏–∫ –¥–ª—è –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
                self.preview_widget.clear()
                self.preview_widget.setText("üìÑ")
                self.preview_widget.setStyleSheet("""
                    QLabel {
                        font-size: 100px;
                        background-color: rgba(255, 255, 255, 0.1);
                        border: 1px solid #4a6fa5;
                        border-radius: 5px;
                    }
                """)

    def clear_preview(self):
        """–û—á–∏—â–∞–µ—Ç –æ–±–ª–∞—Å—Ç—å –ø—Ä–µ–≤—å—é –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–º–∞–π–ª–∏–∫"""
        self.preview_widget.clear()
        self.preview_widget.setText("üìÑ")
        self.preview_widget.setStyleSheet("""
            QLabel {
                font-size: 100px;
                background-color: rgba(255, 255, 255, 0.1);
                border: 1px solid #4a6fa5;
                border-radius: 5px;
            }
        """)    

    def download_document(self, remote_path):
        """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–∞"""
        try:
            filename = os.path.basename(remote_path)
            
            if '–í—Ö–æ–¥—è—â–∏–µ' in remote_path:
                local_dir = self.incoming_dir
                if '–í—Ö–æ–¥—è—â–∏–µ/' in remote_path:
                    sender = remote_path.split('–í—Ö–æ–¥—è—â–∏–µ/')[1].split('/')[0]
                    if sender:
                        local_dir = os.path.join(self.incoming_dir, sender)
                        os.makedirs(local_dir, exist_ok=True)
            else:
                local_dir = self.outgoing_dir
            
            local_path = os.path.join(local_dir, filename)
            
            # –ü–æ–º–µ—á–∞–µ–º —Ñ–∞–π–ª –∫–∞–∫ –∑–∞–≥—Ä—É–∂–∞—é—â–∏–π—Å—è
            self.download_status[remote_path] = "downloading"
            self.update_document_item(remote_path, "downloading")
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
            self.download_thread = DownloadThread(self.webdav_client, remote_path, local_path)
            self.download_thread.finished.connect(self.on_download_finished)
            self.download_thread.start()
            
        except Exception as e:
            QMessageBox.warning(self, "–û—à–∏–±–∫–∞", f"–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞: {str(e)}")

    def on_download_finished(self, success, message, remote_path, local_path):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏"""
        if success:
            # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
            data = self.load_data()
            for doc in data['documents']:
                if doc.get('remote_path') == remote_path:
                    doc['path'] = local_path
                    # –ù–µ —É–¥–∞–ª—è–µ–º remote_path, –æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è –≤–æ–∑–º–æ–∂–Ω—ã—Ö future needs
                    break
            
            self.save_data(data)
            
            # –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏
            if remote_path in self.download_status:
                del self.download_status[remote_path]
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
            self.load_documents()
        else:
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            QMessageBox.warning(self, "–û—à–∏–±–∫–∞", message)
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ –æ—à–∏–±–∫—É
            self.download_status[remote_path] = "error"
            self.update_document_item(remote_path, "error")

    def update_document_item(self, remote_path, status):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–ø–∏—Å–∫–∞ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —Å—Ç–∞—Ç—É—Å–æ–º"""
        for i in range(self.documents_list.count()):
            item = self.documents_list.item(i)
            widget = self.documents_list.itemWidget(item)
            
            if widget and hasattr(widget, 'remote_path') and widget.remote_path == remote_path:
                if status == "downloading":
                    # –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –Ω–∞ —Å–∏–Ω–∏–π (–∑–∞–≥—Ä—É–∑–∫–∞)
                    item.setBackground(QColor(100, 150, 255, 100))
                    # –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É –∏ –º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç
                    for child in widget.children():
                        if isinstance(child, QPushButton):
                            child.setText("–ó–∞–≥—Ä—É–∑–∫–∞...")
                            child.setEnabled(False)
                            break
                elif status == "error":
                    # –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –Ω–∞ –∫—Ä–∞—Å–Ω—ã–π (–æ—à–∏–±–∫–∞)
                    item.setBackground(QColor(255, 100, 100, 100))
                    # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                    for child in widget.children():
                        if isinstance(child, QPushButton):
                            child.setText("–ó–∞–≥—Ä—É–∑–∏—Ç—å")
                            child.setEnabled(True)
                            break
                break

    def init_ui(self):
        central_widget = QWidget()
        self.setCentralWidget(central_widget)
        
        # –û—Å–Ω–æ–≤–Ω–æ–π layout
        main_layout = QHBoxLayout(central_widget)
        main_layout.setContentsMargins(20, 20, 20, 20)
        
        # –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        left_panel = QWidget()
        left_panel.setFixedWidth(200)
        left_layout = QVBoxLayout(left_panel)
        left_layout.setAlignment(Qt.AlignmentFlag.AlignTop)

        # –õ–æ–≥–æ (–µ—Å–ª–∏ –µ—Å—Ç—å name.png)
        logo_label = QLabel()
        logo_pixmap = QPixmap("name.png")
        if not logo_pixmap.isNull():
            logo_pixmap = logo_pixmap.scaled(
                200, 200,
                Qt.AspectRatioMode.KeepAspectRatio,
                Qt.TransformationMode.SmoothTransformation
            )
            logo_label.setPixmap(logo_pixmap)
            logo_label.setAlignment(Qt.AlignmentFlag.AlignBottom | Qt.AlignmentFlag.AlignCenter)
            logo_label.setStyleSheet("background: transparent;")
            left_layout.addWidget(logo_label)

        # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        title_label = QLabel("–ê—Ä—Ö–∏–≤ Local/Web")
        title_label.setStyleSheet("""
            QLabel {
                font-size: 16px;
                font-weight: bold;
                color: white;
                padding: 10px;
                background-color: rgba(0, 0, 0, 0.2);
                border-radius: 5px;
            }
        """)
        title_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        left_layout.addWidget(title_label)
        
        # –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        self.upload_btn = QPushButton("–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç")
        self.delete_btn = QPushButton("–£–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç")
        self.sync_btn = QPushButton("–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è")
        self.settings_btn = QPushButton("–ù–∞—Å—Ç—Ä–æ–π–∫–∏")
        
        buttons = [
            (self.upload_btn, self.upload_document),
            (self.delete_btn, self.delete_document),
            (self.sync_btn, self.sync_documents),
            (self.settings_btn, self.open_settings)
        ]
        
        for btn, handler in buttons:
            btn.setStyleSheet("""
                QPushButton {
                    background-color: #4a6fa5;
                    color: white;
                    border: none;
                    padding: 10px;
                    border-radius: 5px;
                    font-weight: bold;
                    margin-top: 10px;
                }
                QPushButton:hover {
                    background-color: #5a7fb5;
                }
                QPushButton:pressed {
                    background-color: #3a5f95;
                }
            """)
            btn.setFixedHeight(40)
            btn.clicked.connect(handler)
            left_layout.addWidget(btn)

        left_layout.addStretch()
        
        # –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å
        center_panel = QWidget()
        center_layout = QVBoxLayout(center_panel)
        
        # –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ –ø–æ–∏—Å–∫–∞
        filter_panel = QWidget()
        filter_layout = QHBoxLayout(filter_panel)
        
        self.filter_combo = QComboBox()
        self.filter_combo.addItems(["–í—Å–µ", "–í—Ö–æ–¥—è—â–∏–µ", "–ò—Å—Ö–æ–¥—è—â–∏–µ"])
        self.filter_combo.currentTextChanged.connect(self.apply_filters)
        
        self.search_edit = QLineEdit()
        self.search_edit.setPlaceholderText("–ü–æ–∏—Å–∫...")
        self.search_edit.textChanged.connect(self.apply_filters)
        
        filter_layout.addWidget(self.filter_combo)
        filter_layout.addWidget(self.search_edit)
        center_layout.addWidget(filter_panel)
        
        # –°–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        scroll_area = QScrollArea()
        scroll_area.setWidgetResizable(True)
        scroll_area.setStyleSheet("""
            QScrollArea {
                border: 2px solid #4a6fa5;
                border-radius: 5px;
                background-color: rgba(255, 255, 255, 0.1);
            }
            QScrollBar:vertical {
                width: 15px;
                background: rgba(255, 255, 255, 0.1);
            }
            QScrollBar::handle:vertical {
                background: #4a6fa5;
                min-height: 20px;
                border-radius: 5px;
            }
        """)
        
        self.documents_list = QListWidget()
        self.documents_list.setStyleSheet("""
            QListWidget {
                background-color: rgba(255, 255, 255, 0.05);
                color: white;
                font-size: 14px;
                border: none;
            }
            QListWidget::item {
                padding: 10px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            QListWidget::item:hover {
                background-color: rgba(255, 255, 255, 0.1);
            }
            QListWidget::item:selected {
                background-color: #4a6fa5;
            }
        """)
        self.documents_list.itemDoubleClicked.connect(self.open_document_threaded)
        self.documents_list.itemClicked.connect(self.show_document_info)
        scroll_area.setWidget(self.documents_list)
        
        center_layout.addWidget(scroll_area)
        
        # –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å (–ø—Ä–µ–≤—å—é + –∏–Ω—Ñ–æ)
        right_panel = QWidget()
        right_panel.setFixedWidth(350)
        right_layout = QVBoxLayout(right_panel)
        
        self.preview_widget = QLabel()
        self.preview_widget.setFixedSize(300, 300)
        self.preview_widget.setStyleSheet("""
            QLabel {
                background-color: rgba(255, 255, 255, 0.1);
                border: 1px solid #4a6fa5;
                border-radius: 5px;
            }
        """)
        self.preview_widget.setAlignment(Qt.AlignmentFlag.AlignCenter)
        right_layout.addWidget(self.preview_widget)
        
        info_title = QLabel("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–∫—É–º–µ–Ω—Ç–µ")
        info_title.setStyleSheet("""
            QLabel {
                font-size: 16px;
                font-weight: bold;
                color: white;
                padding: 10px;
                background-color: rgba(0, 0, 0, 0.2);
                border-radius: 5px;
            }
        """)
        info_title.setAlignment(Qt.AlignmentFlag.AlignCenter)
        right_layout.addWidget(info_title)
        
        self.info_widget = QWidget()
        self.info_layout = QFormLayout(self.info_widget)
        self.info_layout.setVerticalSpacing(8)
        self.info_layout.setContentsMargins(15, 10, 10, 10)

        # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è –∏–Ω—Ñ–æ-–ø–∞–Ω–µ–ª–∏
        fields = [
            ("–ù–∞–∑–≤–∞–Ω–∏–µ", "name_label"),
            ("–¢–∏–ø", "type_label"),
            ("–ù–æ–º–µ—Ä –ø–∏—Å—å–º–∞", "doc_number_label"),
            ("–î–∞—Ç–∞ –ø–∏—Å—å–º–∞", "doc_date_label"),
            ("–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å", "sender_label"),
            ("–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å", "executor_label"),
            ("–†–∞–∑–º–µ—Ä", "size_label"),
            ("–ü—É—Ç—å", "path_label"),
            ("–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è", "date_label")
        ]
        
        for field_name, field_var in fields:
            label = QLabel(field_name + ":")
            label.setStyleSheet("""
                QLabel {
                    font-size: 12px;
                    color: white;
                    font-weight: bold;
                }
            """)
            
            value_label = QLabel("-")
            value_label.setStyleSheet("""
                QLabel {
                    font-size: 12px;
                    color: white;
                    margin: 2px;
                    padding: 2px;
                }
            """)
            value_label.setWordWrap(True)
            value_label.setAlignment(Qt.AlignmentFlag.AlignLeft | Qt.AlignmentFlag.AlignTop)
            value_label.setSizePolicy(QSizePolicy.Policy.Expanding, QSizePolicy.Policy.MinimumExpanding)
            
            setattr(self, field_var, value_label)
            self.info_layout.addRow(label, value_label)

        right_layout.addWidget(self.info_widget)
        right_layout.addStretch()
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø–∞–Ω–µ–ª–∏ –≤ layout
        main_layout.addWidget(left_panel)
        main_layout.addWidget(center_panel)
        main_layout.addWidget(right_panel)
        
        # –°—Ç–∏–ª—å –≥–ª–∞–≤–Ω–æ–≥–æ –æ–∫–Ω–∞ –∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        self.setStyleSheet("""
            QMainWindow {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:1,
                                        stop:0 #614385, stop:1 #516395);
            }
            QLineEdit, QComboBox {
                background-color: rgba(255, 255, 255, 0.1);
                color: white;
                border: 1px solid #4a6fa5;
                border-radius: 5px;
                padding: 6px;
            }
            QLineEdit:focus, QComboBox:focus {
                border: 1px solid #5a7fb5;
                background-color: rgba(255, 255, 255, 0.15);
            }
            QComboBox QAbstractItemView {
                background-color: #516395;
                color: white;
                selection-background-color: #4a6fa5;
            }
        """)


    
    def open_settings(self):
        """–û—Ç–∫—Ä—ã—Ç–∏–µ –¥–∏–∞–ª–æ–≥–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫"""
        dialog = SettingsDialog(self)
        dialog.exec()
        self.load_documents()
    
    def apply_filters(self):
        """—Ñ–∏–ª—å—Ç—Ä –ø–æ–∏—Å–∫–∞ —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö –ø–æ–ª–µ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞"""
        search_text = self.search_edit.text().lower()
        filter_type = self.filter_combo.currentText()
        
        for i in range(self.documents_list.count()):
            item = self.documents_list.item(i)
            widget = self.documents_list.itemWidget(item)
            doc = item.data(Qt.ItemDataRole.UserRole)
            visible = True
            
            # –ø–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –ø–æ–ª—è–º –¥–æ–∫—É–º–µ–Ω—Ç–∞
            if search_text:
                search_fields = [
                    doc["filename"].lower(),
                    doc.get("sender", "").lower(),
                    doc.get("executor", "").lower(),
                    doc.get("doc_number", "").lower(),
                    doc.get("doc_date", "").lower(),
                    doc.get("description", "").lower()
                ]
                if not any(search_text in field for field in search_fields):
                    visible = False
            
            # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É
            if visible and filter_type != "–í—Å–µ":
                if filter_type == "–í—Ö–æ–¥—è—â–∏–µ" and doc["type"] != "incoming":
                    visible = False
                
                elif filter_type == "–ò—Å—Ö–æ–¥—è—â–∏–µ" and doc["type"] != "outgoing":
                    visible = False
                
                elif filter_type == "–ü–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è–º":
                    if not doc.get("executor"):
                        visible = False
                    elif search_text and search_text not in doc.get("executor", "").lower():
                        visible = False
                
                elif filter_type == "–ü–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è–º":
                    if not doc.get("sender"):
                        visible = False
                    elif search_text and search_text not in doc.get("sender", "").lower():
                        visible = False
            
            item.setHidden(not visible)
            
            # –¢–∞–∫–∂–µ —Å–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–¥–∂–µ—Ç
            if widget:
                widget.setVisible(not visible)

    def load_documents(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å –∫–Ω–æ–ø–∫–æ–π '–ó–∞–≥—Ä—É–∑–∏—Ç—å' —Å–ø—Ä–∞–≤–∞"""
        data = self.load_data()
        self.documents_list.clear()
        
        for doc in data["documents"]:
            # –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞
            item = QListWidgetItem()
            item.setData(Qt.ItemDataRole.UserRole, doc)
            
            if doc['path'].startswith('yadisk:'):
                # –î–ª—è —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∫–æ–Ω–∫—É –∏ —Ü–≤–µ—Ç
                item.setIcon(QIcon.fromTheme("cloud-download"))
                item.setForeground(Qt.GlobalColor.gray)
                
                # –°–æ–∑–¥–∞–µ–º –≤–∏–¥–∂–µ—Ç —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
                widget = QWidget()
                layout = QHBoxLayout(widget)
                layout.setContentsMargins(5, 2, 5, 2)
                layout.setSpacing(10)
                
                # –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É —Å –∏–º–µ–Ω–µ–º —Ñ–∞–π–ª–∞
                label = QLabel(doc["filename"])
                label.setStyleSheet("color: gray;")
                label.setWordWrap(False)  # –ø–µ—Ä–µ–Ω–æ—Å —Ç–µ–∫—Å—Ç–∞

                spacer = QWidget()
                spacer.setSizePolicy(QSizePolicy.Policy.Expanding, QSizePolicy.Policy.Preferred)
                
                btn = QPushButton("–ó–∞–≥—Ä—É–∑–∏—Ç—å")
                btn.setStyleSheet("""
                    QPushButton {
                        background-color: #4a6fa5;
                        color: white;
                        border: none;
                        padding: 3px 8px;
                        border-radius: 4px;
                        font-size: 12px;
                        min-width: 80px;
                    }
                    QPushButton:hover {
                        background-color: #5a7fb5;
                    }
                """)
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º remote_path –≤ –≤–∏–¥–∂–µ—Ç–µ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                widget.remote_path = doc['remote_path']
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏
                if doc['remote_path'] in self.download_status:
                    status = self.download_status[doc['remote_path']]
                    if status == "downloading":
                        item.setBackground(QColor(100, 150, 255, 100))
                        btn.setText("–ó–∞–≥—Ä—É–∑–∫–∞...")
                        btn.setEnabled(False)
                    elif status == "error":
                        item.setBackground(QColor(255, 100, 100, 100))
                        btn.setText("–ó–∞–≥—Ä—É–∑–∏—Ç—å")
                        btn.setEnabled(True)
                
                btn.clicked.connect(lambda _, p=doc['remote_path']: self.download_document(p))
                
                layout.addWidget(label)
                layout.addWidget(spacer)
                layout.addWidget(btn)
                
                self.documents_list.addItem(item)
                self.documents_list.setItemWidget(item, widget)
                
                # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
                height = label.sizeHint().height() + 10  # + –æ—Ç—Å—Ç—É–ø—ã
                item.setSizeHint(QSize(item.sizeHint().width(), max(40, height)))
            else:
                # –î–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –∏ –∏–∫–æ–Ω–∫—É
                item.setText(doc["filename"])
                
                if doc['filename'].lower().endswith('.pdf'):
                    item.setIcon(QIcon.fromTheme("application-pdf"))
                elif doc['filename'].lower().endswith(('.png', '.jpg', '.jpeg')):
                    item.setIcon(QIcon.fromTheme("image-x-generic"))
                else:
                    item.setIcon(QIcon.fromTheme("text-x-generic"))
                
                self.documents_list.addItem(item)

    def sort_documents(self, key):
        """–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –∫–ª—é—á—É"""
        if hasattr(self, 'last_sort_key') and self.last_sort_key == key:
            self.sort_reverse = not self.sort_reverse
        else:
            self.sort_reverse = False
        
        self.last_sort_key = key
        self.load_documents(sort_by=key, reverse=self.sort_reverse)
        
        for field_key, label in self.sort_labels.items():
            if field_key == key:
                label.setStyleSheet("""
                    QLabel {
                        font-size: 12px;
                        color: #4a6fa5;
                        font-weight: bold;
                        text-decoration: underline;
                    }
                """)
            else:
                label.setStyleSheet("""
                    QLabel {
                        font-size: 12px;
                        color: white;
                        font-weight: bold;
                    }
                    QLabel:hover {
                        color: #4a6fa5;
                        text-decoration: underline;
                    }
                """)    

    def upload_document(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞"""
        type_dialog = QDialog(self)
        type_dialog.setWindowTitle("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞")
        type_dialog.setFixedSize(300, 150)
        
        layout = QVBoxLayout()
        type_dialog.setLayout(layout)
        
        label = QLabel("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∑–∞–≥—Ä—É–∂–∞–µ–º–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞:")
        incoming_btn = QPushButton("–í—Ö–æ–¥—è—â–µ–µ –ø–∏—Å—å–º–æ")
        outgoing_btn = QPushButton("–ò—Å—Ö–æ–¥—è—â–µ–µ –ø–∏—Å—å–º–æ")
        
        incoming_btn.clicked.connect(lambda: self.process_document_upload("incoming", type_dialog))
        outgoing_btn.clicked.connect(lambda: self.process_document_upload("outgoing", type_dialog))
        
        layout.addWidget(label)
        layout.addWidget(incoming_btn)
        layout.addWidget(outgoing_btn)
        
        type_dialog.exec()
    
    def upload_to_yadisk(self, file_path, doc_type, doc_data):
        """–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–æ–∑–¥–∞–Ω–∏–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–∞–ø–æ–∫"""
        try:
            filename = os.path.basename(file_path)
            base_dir = '/–î–æ–∫—É–º–µ–Ω—Ç—ã/'
            remote_path = None
            
            if not self.webdav_client.check(base_dir):
                self.webdav_client.mkdir(base_dir)

            if doc_type == "incoming": 
                remote_dir = f'{base_dir}–í—Ö–æ–¥—è—â–∏–µ/'

                if not self.webdav_client.check(remote_dir):
                    self.webdav_client.mkdir(remote_dir)
                
                sender = doc_data.get("sender")
                if sender:
                    sender_dir = f'{remote_dir}{sender}/'
                    if not self.webdav_client.check(sender_dir):
                        self.webdav_client.mkdir(sender_dir)
                    remote_path = f'{sender_dir}{filename}'
                else:
                    remote_path = f'{remote_dir}{filename}'
                    
            elif doc_type == "outgoing":
                remote_dir = f'{base_dir}–ò—Å—Ö–æ–¥—è—â–∏–µ/'
                
                if not self.webdav_client.check(remote_dir):
                    self.webdav_client.mkdir(remote_dir)
                
                executor = doc_data.get("executor")
                if executor:
                    executor_dir = f'{remote_dir}{executor}/'
                    if not self.webdav_client.check(executor_dir):
                        self.webdav_client.mkdir(executor_dir)
                    
                    remote_path = f'{executor_dir}{filename}'
                else:
                    remote_path = f'{remote_dir}{filename}'
            
            if not remote_path:
                raise Exception("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—É—Ç—å –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫")
            
            if self.webdav_client.check(remote_path):
                raise Exception(f"–§–∞–π–ª {filename} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–µ –ø–æ –ø—É—Ç–∏ {remote_path}")
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
            self.upload_thread = UploadThread(self.webdav_client, remote_path, file_path)
            self.upload_thread.finished.connect(lambda success, msg: self.on_upload_finished(success, msg, doc_data, remote_path))
            self.upload_thread.start()
            
            return True
        
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫: {e}")
            # –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–∞–ª—å—à–µ
            raise Exception(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫: {str(e)}")
    
    def on_upload_finished(self, success, message, doc_data, remote_path):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫"""
        if success:
            doc_data['remote_path'] = remote_path
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
            data = self.load_data()
            data['documents'].append(doc_data)
            self.save_data(data)
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            self.load_documents()
        else:
            QMessageBox.critical(
                self,
                "–û—à–∏–±–∫–∞",
                f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç:\n{message}"
            )
    
    def process_document_upload(self, doc_type, type_dialog):
        """–ü–æ–ª–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞"""
        type_dialog.close()
        
        # 1. –í—ã–±–æ—Ä —Ñ–∞–π–ª–∞
        file_path, _ = QFileDialog.getOpenFileName(
            self,
            "–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç",
            "",
            "–î–æ–∫—É–º–µ–Ω—Ç—ã (*.pdf *.doc *.docx *.txt);;–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (*.png *.jpg *.jpeg);;–í—Å–µ —Ñ–∞–π–ª—ã (*)"
        )
        
        if not file_path:
            return
        
        # 2. –ó–∞–ø—Ä–æ—Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        upload_dialog = DocumentUploadDialog(doc_type, self)
        if upload_dialog.exec() != QDialog.DialogCode.Accepted:
            return
        
        doc_details = upload_dialog.get_data()
        if not doc_details["doc_number"]:
            QMessageBox.warning(self, "–û—à–∏–±–∫–∞", "–ù–æ–º–µ—Ä –ø–∏—Å—å–º–∞ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω")
            return
        
        filename = os.path.basename(file_path)
        data = self.load_data()
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç
        for doc in data['documents']:
            if doc['filename'].lower() == filename.lower() and doc['type'] == doc_type:
                QMessageBox.warning(self, "–û—à–∏–±–∫–∞", "–î–æ–∫—É–º–µ–Ω—Ç —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º –∏ —Ç–∏–ø–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
                return
        
        # 3. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞
        doc_data = {
            'filename': filename,
            'type': doc_type,
            'doc_number': doc_details['doc_number'],
            'doc_date': doc_details['doc_date'],
            'date': datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            'size': int(os.path.getsize(file_path))
        }

        try:
            # 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
            if doc_type == "incoming":
                sender = self.select_or_create_entity("sender", "–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è", "–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è")
                if not sender:
                    return
                
                doc_data['sender'] = sender
                
                # –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –ª–æ–∫–∞–ª—å–Ω–æ
                sender_dir = os.path.join(self.incoming_dir, sender)
                os.makedirs(sender_dir, exist_ok=True)
                
                # –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
                local_path = os.path.join(sender_dir, filename)
                shutil.copy2(file_path, local_path)
                
            elif doc_type == "outgoing":
                executor = self.select_or_create_entity("executor", "–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è", "–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è")
                if not executor:
                    return
                
                doc_data['executor'] = executor
                
                # –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –ª–æ–∫–∞–ª—å–Ω–æ
                executor_dir = os.path.join(self.outgoing_dir, executor)
                os.makedirs(executor_dir, exist_ok=True)
                
                # –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
                local_path = os.path.join(executor_dir, filename)
                shutil.copy2(file_path, local_path)
            
            # 5. –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—É—Ç—å
            doc_data['path'] = local_path
            
            # 6. –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫ (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
            self.upload_to_yadisk(local_path, doc_type, doc_data)
            
        except Exception as e:
            # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
            if 'local_path' in locals() and os.path.exists(local_path):
                os.remove(local_path)
                
            QMessageBox.critical(
                self,
                "–û—à–∏–±–∫–∞",
                f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç:\n{str(e)}"
            )
        
    def select_or_create_entity(self, entity_type, select_title, create_title):
        """–í—ã–±–æ—Ä –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è/–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è"""
        data = self.load_data()
        entities = data[f"{entity_type}s"]
        
        dialog = QDialog(self)
        dialog.setWindowTitle(select_title)
        dialog.setFixedSize(300, 200)
        
        layout = QVBoxLayout()
        dialog.setLayout(layout)
        
        entity_list = QListWidget()
        for entity in entities:
            entity_list.addItem(entity["name"])
        
        # –ö–Ω–æ–ø–æ—á–∫–∏
        btn_layout = QHBoxLayout()
        select_btn = QPushButton("–í—ã–±—Ä–∞—Ç—å")
        create_btn = QPushButton(create_title)
        cancel_btn = QPushButton("–û—Ç–º–µ–Ω–∞")
        
        selected_entity = None
        
        def on_select():
            nonlocal selected_entity
            if entity_list.currentItem():
                selected_entity = entity_list.currentItem().text()
                dialog.accept()
        
        def on_create():
            nonlocal selected_entity
            new_entity = self.create_new_entity(entity_type, dialog)
            if new_entity:
                # –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                entity_list.clear()
                data = self.load_data()
                for entity in data[f"{entity_type}s"]:
                    entity_list.addItem(entity["name"])
                # –í—ã–±–∏—Ä–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ
                for i in range(entity_list.count()):
                    if entity_list.item(i).text() == new_entity:
                        entity_list.setCurrentRow(i)
                        break
        
        select_btn.clicked.connect(on_select)
        create_btn.clicked.connect(on_create)
        cancel_btn.clicked.connect(dialog.reject)
        
        btn_layout.addWidget(select_btn)
        btn_layout.addWidget(create_btn)
        btn_layout.addWidget(cancel_btn)
        
        layout.addWidget(entity_list)
        layout.addLayout(btn_layout)
        
        if dialog.exec() == QDialog.DialogCode.Accepted:
            return selected_entity
        
        return None
    
    def create_new_entity(self, entity_type, parent_dialog):
        """–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è/–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –±–µ–∑ –∑–∞–∫—Ä—ã—Ç–∏—è —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞"""
        dialog = QDialog(self)
        dialog.setWindowTitle(f"–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ {entity_type}")
        dialog.setFixedSize(300, 150)
        
        layout = QFormLayout()
        dialog.setLayout(layout)
        
        name_edit = QLineEdit()
        description_edit = QLineEdit()
        
        layout.addRow("–ò–º—è:", name_edit)
        layout.addRow("–û–ø–∏—Å–∞–Ω–∏–µ:", description_edit)
        
        button_box = QDialogButtonBox(QDialogButtonBox.StandardButton.Ok | QDialogButtonBox.StandardButton.Cancel)
        button_box.accepted.connect(dialog.accept)
        button_box.rejected.connect(dialog.reject)
        
        layout.addRow(button_box)
        
        if dialog.exec() == QDialog.DialogCode.Accepted:
            name = name_edit.text().strip()
            if not name:
                QMessageBox.warning(self, "–û—à–∏–±–∫–∞", "–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º")
                return None
            
            data = self.load_data()
            entities = data[f"{entity_type}s"]
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º
            if any(e["name"].lower() == name.lower() for e in entities):
                QMessageBox.warning(self, "–û—à–∏–±–∫–∞", f"{entity_type} —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
                return None
            
            new_id = max(e["id"] for e in entities) + 1 if entities else 1
            new_entity = {
                "id": new_id,
                "name": name,
                "description": description_edit.text(),
                "created_at": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            }
            
            entities.append(new_entity)
            self.save_data(data)
            
            # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–µ
            base_dir = '/–î–æ–∫—É–º–µ–Ω—Ç—ã/'
            if entity_type == "sender":
                remote_dir = f'{base_dir}–í—Ö–æ–¥—è—â–∏–µ/{name}/'
            else:
                remote_dir = f'{base_dir}–ò—Å—Ö–æ–¥—è—â–∏–µ/{name}/'
            
            if not self.webdav_client.check(remote_dir):
                self.webdav_client.mkdir(remote_dir)
            
            return name
        
        return None
    
    def delete_document(self):
        """–£–¥–∞–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ"""
        if not (selected_item := self.documents_list.currentItem()):
            QMessageBox.warning(self, "–û—à–∏–±–∫–∞", "–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è")
            return
        
        doc = selected_item.data(Qt.ItemDataRole.UserRole)
        filename = doc["filename"]
        
        reply = QMessageBox.question(
            self, 
            '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ', 
            f'–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª {filename}?', 
            QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No
        )
        
        if reply != QMessageBox.StandardButton.Yes:
            return
        
        try:
            # –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—É—é –∫–æ–ø–∏—é
            if os.path.exists(doc.get("path", "")):
                os.remove(doc["path"])
            
            # –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
            data = self.load_data()
            data["documents"] = [
                d for d in data["documents"] 
                if not (d["filename"] == filename and 
                    d.get("type") == doc.get("type") and 
                    d.get("doc_number") == doc.get("doc_number"))
            ]
            self.save_data(data)
            
            self.load_documents()
            self.clear_document_info()
            
        except Exception as e:
            QMessageBox.warning(self, "–û—à–∏–±–∫–∞", f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª: {str(e)}")

    def sync_documents(self):
        """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–æ–º"""
        # –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –∏ –æ—Ç–∫–ª—é—á–∞–µ–º –µ–µ
        self.sync_btn.setText("–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...")
        self.sync_btn.setEnabled(False)
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
        self.sync_thread = SyncThread(self.webdav_client, self.base_dir, self.data_file)
        self.sync_thread.finished.connect(self.on_sync_finished)
        self.sync_thread.progress.connect(self.on_sync_progress)
        self.sync_thread.start()

    def on_sync_progress(self, message):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏"""
        self.sync_btn.setText(message)

    def on_sync_finished(self, success, message):
        """–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏"""
        # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        self.sync_btn.setText("–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è")
        self.sync_btn.setEnabled(True)
        
        if success:
            self.load_documents()
            QMessageBox.information(self, "–£—Å–ø–µ—Ö", message)
        else:
            QMessageBox.warning(self, "–û—à–∏–±–∫–∞", message)

    def open_document_threaded(self):
        selected_item = self.documents_list.currentItem()
        if not selected_item:
            QMessageBox.warning(self, "–û—à–∏–±–∫–∞", "–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è")
            return
        
        doc = selected_item.data(Qt.ItemDataRole.UserRole)
        file_path = doc["path"]

        if file_path.startswith('yadisk:'):
            QMessageBox.information(self, "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", "–°–Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª —Å –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–∞")
            return

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
        if not os.path.exists(file_path):
            QMessageBox.warning(self, "–û—à–∏–±–∫–∞", "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω. –í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω –±—ã–ª —É–¥–∞–ª–µ–Ω.")
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Ñ–∞–π–ª–∞
            self.validate_local_files()
            self.load_documents()
            return

        # –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
        self.open_thread = OpenFileThread(file_path)
        self.open_thread.finished.connect(self.open_thread.deleteLater)
        self.open_thread.start()


    def open_file(self, file_path):
        """–û—Ç–∫—Ä—ã—Ç–∏–µ —Ñ–∞–π–ª–∞ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ)"""
        try:
            if sys.platform == 'win32':
                os.startfile(file_path)
            elif sys.platform == 'darwin':
                os.system(f'open "{file_path}"')
            else:
                os.system(f'xdg-open "{file_path}"')
        except Exception as e:
            QMessageBox.warning(self, "–û—à–∏–±–∫–∞", f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª: {str(e)}")

    def calculate_text_height(self, text, width):
        fm = QFontMetrics(self.font())
        text_rect = fm.boundingRect(0, 0, width, 0, 
                                Qt.TextFlag.TextWordWrap, text)
        return text_rect.height()

    def show_document_info(self, item):
        """–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–∫—É–º–µ–Ω—Ç–µ –∏ –µ–≥–æ –ø—Ä–µ–≤—å—é"""
        if not item:
            return
            
        doc = item.data(Qt.ItemDataRole.UserRole)
        if not doc:
            return
        
        try:
            filename = doc.get("filename", "-")
            path = doc.get("path", "-")
            doc_type = doc.get("type", "")
            doc_number = doc.get("doc_number", "-")
            doc_date = doc.get("doc_date", "-")
            sender = doc.get("sender", "-")
            executor = doc.get("executor", "-")
            date_added = doc.get("date", "-")
            
            try:
                size_bytes = int(doc.get("size", 0))
                if size_bytes >= 1024 * 1024:  # –ë–æ–ª—å—à–µ 1 MB
                    size_text = f"{size_bytes/(1024*1024):.2f} MB"
                elif size_bytes >= 1024:  # –ë–æ–ª—å—à–µ 1 KB
                    size_text = f"{size_bytes/1024:.2f} KB"
                else:
                    size_text = f"{size_bytes} B"
            except (ValueError, TypeError):
                size_text = "0 B"

            self.name_label.setText(filename)
            self.path_label.setText(path)
            self.type_label.setText("–í—Ö–æ–¥—è—â–∏–π" if doc_type == "incoming" else "–ò—Å—Ö–æ–¥—è—â–∏–π")
            self.doc_number_label.setText(doc_number)
            self.doc_date_label.setText(doc_date)
            self.sender_label.setText(sender)
            self.executor_label.setText(executor)
            self.size_label.setText(size_text)
            self.date_label.setText(date_added)
            
            max_width = max(self.info_widget.width() - 30, 100)
            font = self.font()
            
            def text_height(text):
                return QFontMetrics(font).boundingRect(
                    0, 0, max_width, 0,
                    Qt.TextFlag.TextWordWrap, text
                ).height() + 5
            
            self.name_label.setMinimumHeight(40)
            self.name_label.setSizePolicy(QSizePolicy.Policy.Expanding, QSizePolicy.Policy.Preferred)
            self.path_label.setMinimumHeight(max(20, text_height(path)))
            self.name_label.setToolTip(filename)
            self.path_label.setToolTip(path)
            self.update_preview(path)
            self.info_widget.layout().activate()
            
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: {str(e)}")
            for label in [self.name_label, self.path_label, self.type_label,
                        self.doc_number_label, self.doc_date_label,
                        self.sender_label, self.executor_label,
                        self.size_label, self.date_label]:
                label.setText("-")
                label.setMinimumHeight(20)
            self.clear_preview()

    def resizeEvent(self, event):
        super().resizeEvent(event)
        if hasattr(self, 'documents_list') and self.documents_list.currentItem():
            current_item = self.documents_list.currentItem()
            if current_item:
                doc = current_item.data(Qt.ItemDataRole.UserRole)
                if doc and "path" in doc:
                    # –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø—Ä–µ–≤—å—é
                    pixmap = self.preview_widget.pixmap()
                    if pixmap and not pixmap.isNull():
                        scaled_pixmap = pixmap.scaled(
                            self.preview_widget.width() - 20, 
                            self.preview_widget.height() - 20,
                            Qt.AspectRatioMode.KeepAspectRatio,
                            Qt.TransformationMode.SmoothTransformation
                        )
                        self.preview_widget.setPixmap(scaled_pixmap)

    def clear_document_info(self):
        self.name_label.setText("-")
        self.type_label.setText("-")
        self.sender_label.setText("-")
        self.executor_label.setText("-")
        self.size_label.setText("-")
        self.path_label.setText("-")
        self.date_label.setText("-")
        self.doc_number_label.setText("-")
        self.doc_date_label.setText("-")
        self.clear_preview()
                
    def show_full_path(self):
        if hasattr(self, 'documents_list') and self.documents_list.currentItem():
            doc = self.documents_list.currentItem().data(Qt.ItemDataRole.UserRole)
            QMessageBox.information(self, "–ü–æ–ª–Ω—ã–π –ø—É—Ç—å", doc["path"])
            
    def migrate_data(self):
        data = self.load_data()
        changed = False
        
        for doc in data["documents"]:
            if isinstance(doc.get("size"), str):
                try:
                    doc["size"] = int(doc["size"])
                    changed = True
                except (ValueError, TypeError):
                    doc["size"] = 0
                    changed = True
        if changed:
            self.save_data(data)

if __name__ == "__main__":
    app = QApplication(sys.argv)
    app.setStyle("Fusion")
    window = DocumentManager()
    window.show()
    sys.exit(app.exec())